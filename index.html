<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</title>
<style>
  :root{
    --bg1:#f6f7ff; --bg2:#eef1ff;
    --card:#ffffff; --text:#141427; --muted:#6b6f93;
    --line:#d7dcff; --accent:#5b6cff;
  }
  body{
    margin:0; font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
    background:linear-gradient(180deg,var(--bg1),var(--bg2));
    color:var(--text);
  }
  main{max-width:980px; margin:0 auto; padding:28px;}
  h1{margin:0 0 14px; letter-spacing:-.2px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  select,button{
    padding:10px 14px; font-size:15px; border-radius:12px;
  }
  select{border:1px solid var(--line); background:white}
  button{
    border:0; background:var(--accent); color:white; cursor:pointer; font-weight:800;
  }
  button:hover{opacity:.92}
  .hint{color:var(--muted); font-size:13px; margin-top:10px; line-height:1.5}
  .grid{display:grid; gap:14px; margin-top:18px}
  @media (min-width:860px){ .grid{grid-template-columns:1fr 1fr} }
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    padding:16px;
    box-shadow:0 10px 25px rgba(0,0,0,.06);
  }
  .card h2{margin:0 0 10px; font-size:16px}
  .item{padding:8px 10px; border:1px solid #eef0ff; border-radius:12px; margin:8px 0}
  .meta{margin-top:6px; color:var(--muted); font-size:12px}
  .badge{
    display:inline-block; margin-left:8px; padding:2px 7px; border-radius:999px;
    background:#eef0ff; color:#3c47a8; font-size:12px; font-weight:700;
    border:1px solid #d9ddff;
  }
  .error{
    background:#fff2f2; border:1px solid #ffd1d1; color:#8a1f1f;
    padding:12px 14px; border-radius:14px; margin-top:14px;
  }
</style>
</head>

<body>
<main>
  <h1>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</h1>

  <div class="row">
    <label>ê²Œì„ ì¢…ë¥˜</label>
    <select id="mode">
      <option value="base">ê¸°ë³¸</option>
      <option value="war">ì˜ì›í•œì „ìŸ</option>
      <option value="both" selected>ê¸°ë³¸ + ì˜ì›í•œì „ìŸ</option>
    </select>

    <button id="roll">ğŸ² ë½‘ê¸°</button>
  </div>

  <div class="hint">
    ê·œì¹™: ë„¤ë©”ì‹œìŠ¤ 1 / ìºë¦­í„° 2 / ë³´ì„ 2 / ìœ ë¬¼ 3 / ì£¼ë¬¸ 4 Â·
    <b>ë¬»ë¹„</b>ëŠ” ì–´ë–¤ ëª¨ë“œì—ì„œë„ í•­ìƒ í¬í•¨ Â· ì¤‘ë³µ ì—†ì´ ë½‘ê¸° Â· ì—í…Œë¥´ ê°’ì€ í‘œì‹œìš©
  </div>

  <div id="msg"></div>
  <div id="result" class="grid"></div>
</main>

<script>
  /* ===== ê·œì¹™ ===== */
  const PICK = { "ë„¤ë©”ì‹œìŠ¤":1, "ìºë¦­í„°":2, "ë³´ì„":2, "ìœ ë¬¼":3, "ì£¼ë¬¸":4 };

  function allowedKinds(mode){
    if(mode==="base") return new Set(["ê¸°ë³¸","ë¬»ë¹„"]);
    if(mode==="war")  return new Set(["ì˜ì „","ë¬»ë¹„"]);
    return new Set(["ê¸°ë³¸","ì˜ì „","ë¬»ë¹„"]);
  }

  /* ===== ì •ê·œí™” ===== */
  const clean = (v)=> (v ?? "").replace(/\uFEFF/g,"").trim();

  function normCategory(v){
    v = clean(v);
    if(v.includes("ë„¤ë©”")) return "ë„¤ë©”ì‹œìŠ¤";
    if(v.includes("ìºë¦­")) return "ìºë¦­í„°";
    if(v.includes("ë³´ì„")) return "ë³´ì„";
    if(v.includes("ìœ ë¬¼")) return "ìœ ë¬¼";
    if(v.includes("ì£¼ë¬¸")) return "ì£¼ë¬¸";
    return v;
  }

  function normKind(v){
    v = clean(v);
    // 'ì˜ì›í•œì „ìŸ' ê°™ì´ ë“¤ì–´ì™€ë„ ì˜ì „ìœ¼ë¡œ í†µì¼
    if(v.includes("ê¸°ë³¸")) return "ê¸°ë³¸";
    if(v.includes("ì˜"))   return "ì˜ì „";
    if(v.includes("ë¬»"))   return "ë¬»ë¹„";
    return v;
  }

  function parseCSV(text){
    const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);

    // í—¤ë”ê°€ ìˆìœ¼ë©´ ì œê±°(ì²« ì¤„ì— 'ì¹´í…Œê³ ë¦¬' ê°™ì€ ë‹¨ì–´ê°€ ìˆìœ¼ë©´ í—¤ë”ë¡œ íŒë‹¨)
    const startIdx = (lines[0] && lines[0].includes("ì¹´í…Œê³ ë¦¬")) ? 1 : 0;

    const rows = [];
    for(let i=startIdx;i<lines.length;i++){
      const line = lines[i];
      // ì‰¼í‘œ CSV ê¸°ì¤€ (ì§€ê¸ˆ ë„ˆ íŒŒì¼ì´ ì´ í˜•íƒœ)
      const parts = line.split(",");
      const c = normCategory(parts[0]);
      const k = normKind(parts[1]);
      const n = clean(parts[2]);
      const e = clean(parts[3]);

      if(!c || !k || !n) continue;
      rows.push({ category:c, kind:k, name:n, ether:e });
    }
    return rows;
  }

  function sampleUnique(arr, n){
    if(n > arr.length) throw new Error(`í›„ë³´ê°€ ${arr.length}ê°œë¼ì„œ ${n}ê°œë¥¼ ì¤‘ë³µ ì—†ì´ ë½‘ì„ ìˆ˜ ì—†ì–´.`);
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a.slice(0,n);
  }

  async function loadData(){
    const res = await fetch("data.csv", { cache: "no-store" });
    if(!res.ok) throw new Error(`data.csvë¥¼ ëª» ë¶ˆëŸ¬ì™”ì–´ (HTTP ${res.status})`);
    const text = await res.text();
    return parseCSV(text);
  }

  function render(resultByCat){
    const box = document.getElementById("result");
    box.innerHTML = "";

    for(const cat of Object.keys(PICK)){
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `<h2>${cat}</h2>`;

      for(const item of resultByCat[cat]){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div><b>${item.name}</b>
            ${item.kind==="ë¬»ë¹„" ? `<span class="badge">ë¬»ë¹„</span>` : ``}
          </div>
          ${item.ether ? `<div class="meta">ì—í…Œë¥´ ${item.ether} Â· ì¢…ë¥˜ ${item.kind}</div>` : `<div class="meta">ì¢…ë¥˜ ${item.kind}</div>`}
        `;
        card.appendChild(div);
      }
      box.appendChild(card);
    }
  }

  async function roll(){
    const msg = document.getElementById("msg");
    msg.innerHTML = "";
    try{
      const rows = await loadData();
      const mode = document.getElementById("mode").value;
      const allowed = allowedKinds(mode);

      const byCat = {};
      for(const r of rows){
        if(!(r.category in PICK)) continue;
        if(!allowed.has(r.kind)) continue;
        (byCat[r.category] ||= []).push(r);
      }

      const result = {};
      for(const [cat, cnt] of Object.entries(PICK)){
        const pool = byCat[cat] || [];
        result[cat] = sampleUnique(pool, cnt);
      }

      render(result);
    }catch(e){
      msg.innerHTML = `<div class="error">${e.message}</div>`;
      document.getElementById("result").innerHTML = "";
    }
  }

  document.getElementById("roll").addEventListener("click", roll);

  // ì²« ë¡œë”© ë•Œ í•œ ë²ˆ ìë™ìœ¼ë¡œ ë½‘ê¸°
  roll();
</script>
</body>
</html>
