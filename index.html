<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</title>

<style>
:root{
  --bg1:#f6f7ff; --bg2:#eef1ff;
  --card:#ffffff; --text:#141427; --muted:#6b6f93;
  --line:#d7dcff; --accent:#5b6cff;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
  background:
    radial-gradient(1200px 500px at 50% -10%, #2b2f5a 0%, transparent 60%),
    linear-gradient(180deg, #0e1024 0%, #15183a 100%);
  color:#e9ecff;
}
main{max-width:980px;margin:0 auto;padding:28px}
h1{margin:0 0 14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select,button,input{
  padding:10px 14px;
  font-size:15px;
  border-radius:12px;
}
select,input{border:1px solid var(--line); background:#fff}
button{
  background:linear-gradient(180deg,#8f9bff,#5c66ff);
  box-shadow:
    0 6px 18px rgba(90,100,255,.35),
    inset 0 1px 0 rgba(255,255,255,.25);
}
button.secondary{
  background:#fff;color:#1a1a2b;border:1px solid var(--line);
  font-weight:700;
}
button:hover{opacity:.92}
.hint{color:var(--muted);font-size:13px;margin-top:10px;line-height:1.5}
.grid{display:grid;gap:14px;margin-top:18px}
@media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
.card{
  background:linear-gradient(180deg,#1b1f45,#16193a);
  border:1px solid rgba(140,155,255,.25);
  border-radius:18px;
  padding:16px;
  box-shadow:
    0 20px 40px rgba(0,0,0,.45),
    inset 0 0 0 1px rgba(255,255,255,.03);
}
.card h2{
  color:#e9ecff;
  font-weight:800;
  letter-spacing:.6px;
}

.item{
  background:rgba(255,255,255,.03);
  border:1px solid rgba(140,155,255,.15);
  backdrop-filter: blur(2px);
}

.item b{
  color:#f5f7ff;
}

.meta{
  color:#aeb4ff;
}
  .hero{
  text-align:center;
  padding:42px 20px 36px;
  margin-bottom:24px;
}

.hero h1{
  margin:0;
  font-size:40px;
  letter-spacing:4px;
  font-weight:900;
  color:#f3f5ff;
  text-shadow:
    0 0 20px rgba(120,140,255,.35),
    0 0 40px rgba(90,110,255,.15);
}

.hero p{
  margin-top:10px;
  color:#aeb4ff;
  font-size:14px;
  letter-spacing:.4px;
}

.badge{
  display:inline-block;margin-left:6px;
  padding:2px 7px;border-radius:999px;
  background:#eef0ff;color:#3c47a8;
  font-size:12px;font-weight:700;
  border:1px solid #d9ddff
}
.error{
  background:#fff2f2;border:1px solid #ffd1d1;
  color:#8a1f1f;padding:12px 14px;
  border-radius:14px;margin-top:14px
}

/* ===== ì„¤ì • ëª¨ë‹¬ ===== */
.modal{
  position:fixed; inset:0;
  background:rgba(20,22,60,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal.open{display:flex}
.modalBox{
  width:min(420px,90vw);
  background:#fff;
  border-radius:18px;
  padding:20px;
  box-shadow:0 20px 50px rgba(0,0,0,.25);
}
.modalBox h2{margin:0 0 8px}
.modalRow{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; margin:12px 0;
}
.modalRow label{font-weight:700}
.modalActions{
  display:flex; gap:10px; justify-content:flex-end; margin-top:18px;
}
</style>
</head>

<body>
<main>
 <header class="hero">
  <h1>AEONâ€™S END</h1>
  <p>ë¬´ì‘ìœ„ë¡œ êµ¬ì„±ë˜ëŠ” ê· ì—´ ë„ˆë¨¸ì˜ ì „íˆ¬</p>
</header>

  <div class="row">
    <label>ê²Œì„ ì¢…ë¥˜</label>
    <select id="mode">
      <option value="base">ê¸°ë³¸</option>
      <option value="war">ì˜ì›í•œì „ìŸ</option>
      <option value="both" selected>ê¸°ë³¸ + ì˜ì›í•œì „ìŸ</option>
      <option value="random">ëœë¤</option>
    </select>

    <button id="roll">ğŸ² ë½‘ê¸°</button>
    <button id="openSettings" class="secondary">âš™ ì„¤ì •</button>
  </div>

  <div class="hint">
    (ì„¤ì • ê°€ëŠ¥) ë³´ì„ / ìœ ë¬¼ / ì£¼ë¬¸ ê°œìˆ˜ Â· <b>ë¬»ë¹„</b>ëŠ” ì–´ë–¤ ëª¨ë“œì—ì„œë„ í•­ìƒ í¬í•¨ Â· ì¤‘ë³µ ì—†ì´ ë½‘ê¸°
  </div>

  <div id="msg" class="hint"></div>
  <div id="result" class="grid"></div>
</main>

<!-- ===== ì„¤ì • ëª¨ë‹¬ ===== -->
<div id="settingsModal" class="modal">
  <div class="modalBox">
    <h2>ì¹´ë“œ ê°œìˆ˜ ì„¤ì •</h2>
    <div class="hint">ì €ì¥í•˜ë©´ ì¦‰ì‹œ ë°˜ì˜ë¼. (ê¸°ë³¸: ë³´ì„ 2 / ìœ ë¬¼ 3 / ì£¼ë¬¸ 4)</div>

    <div class="modalRow">
      <label for="set-gem">ë³´ì„</label>
      <input type="number" id="set-gem" min="0" step="1">
    </div>
    <div class="modalRow">
      <label for="set-relic">ìœ ë¬¼</label>
      <input type="number" id="set-relic" min="0" step="1">
    </div>
    <div class="modalRow">
      <label for="set-spell">ì£¼ë¬¸</label>
      <input type="number" id="set-spell" min="0" step="1">
    </div>

    <div class="modalActions">
      <button id="resetSettings" class="secondary">ì´ˆê¸°í™”</button>
      <button id="saveSettings">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
/* ===== ê¸°ë³¸ê°’: 'í‘œì‹œ'ê°€ ì•„ë‹ˆë¼ ì‹¤ì œë¡œ ì„¸íŒ… ===== */
const DEFAULTS = { gem:2, relic:3, spell:4 };

function ensureDefaults(){
  if(localStorage.getItem("pick_gem") === null)   localStorage.setItem("pick_gem", String(DEFAULTS.gem));
  if(localStorage.getItem("pick_relic") === null) localStorage.setItem("pick_relic", String(DEFAULTS.relic));
  if(localStorage.getItem("pick_spell") === null) localStorage.setItem("pick_spell", String(DEFAULTS.spell));
}
ensureDefaults();

function getNum(key, fallback){
  const v = Number(localStorage.getItem(key));
  return Number.isFinite(v) ? v : fallback;
}

/* ===== ê·œì¹™ ===== */
function allowedKinds(mode){
  if(mode==="base") return new Set(["ê¸°ë³¸","ë¬»ë¹„"]);
  if(mode==="war")  return new Set(["ì˜ì „","ë¬»ë¹„"]);
  return new Set(["ê¸°ë³¸","ì˜ì „","ë¬»ë¹„"]);
}

function getPickConfig(){
  return {
    "ë„¤ë©”ì‹œìŠ¤": 1,
    "ìºë¦­í„°": 2,
    "ë³´ì„": getNum("pick_gem", DEFAULTS.gem),
    "ìœ ë¬¼": getNum("pick_relic", DEFAULTS.relic),
    "ì£¼ë¬¸": getNum("pick_spell", DEFAULTS.spell),
  };
}

/* ===== CSV íŒŒì‹± ===== */
const clean = (v)=> (v ?? "").replace(/\uFEFF/g,"").trim();

function normCategory(v){
  v = clean(v);
  if(v.includes("ë„¤ë©”")) return "ë„¤ë©”ì‹œìŠ¤";
  if(v.includes("ìºë¦­")) return "ìºë¦­í„°";
  if(v.includes("ë³´ì„")) return "ë³´ì„";
  if(v.includes("ìœ ë¬¼")) return "ìœ ë¬¼";
  if(v.includes("ì£¼ë¬¸")) return "ì£¼ë¬¸";
  return v;
}
function normKind(v){
  v = clean(v);
  if(v.includes("ê¸°ë³¸")) return "ê¸°ë³¸";
  if(v.includes("ì˜"))   return "ì˜ì „"; // ì˜ì›í•œì „ìŸ/ì˜ì „ ëª¨ë‘ ì²˜ë¦¬
  if(v.includes("ë¬»"))   return "ë¬»ë¹„";
  return v;
}

function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const startIdx = (lines[0] && lines[0].includes("ì¹´í…Œê³ ë¦¬")) ? 1 : 0;

  const rows = [];
  for(let i=startIdx;i<lines.length;i++){
    const p = lines[i].split(",");
    const category = normCategory(p[0]);
    const kind = normKind(p[1]);
    const name = clean(p[2]);
    const ether = clean(p[3]);
    if(!category || !kind || !name) continue;
    rows.push({ category, kind, name, ether });
  }
  return rows;
}

async function loadData(){
  const res = await fetch("data.csv", { cache:"no-store" });
  if(!res.ok) throw new Error(`data.csvë¥¼ ëª» ë¶ˆëŸ¬ì™”ì–´ (HTTP ${res.status})`);
  return parseCSV(await res.text());
}

/* ===== ëœë¤ ìœ í‹¸ ===== */
function shuffled(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function sampleUnique(pool, n){
  if(n <= 0) return [];
  if(n > pool.length) throw new Error(`í›„ë³´ê°€ ${pool.length}ê°œë¼ì„œ ${n}ê°œë¥¼ ì¤‘ë³µ ì—†ì´ ë½‘ì„ ìˆ˜ ì—†ì–´.`);
  return shuffled(pool).slice(0,n);
}

/* ===== ë Œë” ===== */
function render(result, pickConfig){
  const box = document.getElementById("result");
  box.innerHTML = "";

  const order = ["ë„¤ë©”ì‹œìŠ¤","ìºë¦­í„°","ë³´ì„","ìœ ë¬¼","ì£¼ë¬¸"];
  for(const cat of order){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h2>${cat} <span class="meta">(ì„ íƒ ${pickConfig[cat]}ê°œ)</span></h2>`;

    for(const item of result[cat]){
      const etherNum = Number(String(item.ether ?? "").replace(/[^\d]/g,""));
      const title = (Number.isFinite(etherNum) && etherNum>0)
        ? `${etherNum}â™ª ${item.name}`
        : item.name;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div><b>${title}</b>${item.kind==="ë¬»ë¹„" ? `<span class="badge">ë¬»ë¹„</span>` : ""}</div>
        <div class="meta">${item.kind}</div>
      `;
      card.appendChild(div);
    }

    box.appendChild(card);
  }
}

/* ===== ë©”ì¸ ë½‘ê¸° ===== */
async function roll(){
  const msg = document.getElementById("msg");
  msg.innerHTML = "";

  let mode = document.getElementById("mode").value;

  // Aëª¨ë“œ: ëœë¤ ì„ íƒì´ë©´ ë½‘ê¸° ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ëª¨ë“œê°€ ëœë¤ìœ¼ë¡œ í™•ì •
  if(mode === "random"){
    const choices = ["base","war","both"];
    mode = choices[Math.floor(Math.random() * choices.length)];
  }

  const modeLabel =
    mode==="base" ? "ê¸°ë³¸" :
    mode==="war" ? "ì˜ì›í•œì „ìŸ" :
    "ê¸°ë³¸ + ì˜ì›í•œì „ìŸ";

  msg.innerHTML = `ì´ë²ˆ íŒ ëª¨ë“œ: <b>${modeLabel}</b>`;

  try{
    const rows = await loadData();
    const allowed = allowedKinds(mode);
    const pickConfig = getPickConfig();

    const byCat = {};
    for(const r of rows){
      if(!(r.category in pickConfig)) continue;
      if(!allowed.has(r.kind)) continue;
      (byCat[r.category] ||= []).push(r);
    }

    const result = {};
    for(const [cat, cnt] of Object.entries(pickConfig)){
      const pool = byCat[cat] || [];
      result[cat] = sampleUnique(pool, cnt);
    }

    render(result, pickConfig);
  }catch(e){
    msg.innerHTML = `<div class="error">${e.message}</div>`;
    document.getElementById("result").innerHTML = "";
  }
}

/* ===== ì„¤ì • ëª¨ë‹¬ ===== */
const modal = document.getElementById("settingsModal");
const setGem = document.getElementById("set-gem");
const setRelic = document.getElementById("set-relic");
const setSpell = document.getElementById("set-spell");

document.getElementById("openSettings").addEventListener("click", () => {
  ensureDefaults();
  modal.classList.add("open");
  setGem.value = getNum("pick_gem", DEFAULTS.gem);
  setRelic.value = getNum("pick_relic", DEFAULTS.relic);
  setSpell.value = getNum("pick_spell", DEFAULTS.spell);
});

// ë°°ê²½ í´ë¦­í•˜ë©´ ë‹«ê¸°
modal.addEventListener("click", (e) => {
  if(e.target === modal) modal.classList.remove("open");
});

document.getElementById("saveSettings").addEventListener("click", () => {
  localStorage.setItem("pick_gem", String(Math.max(0, Number(setGem.value || 0))));
  localStorage.setItem("pick_relic", String(Math.max(0, Number(setRelic.value || 0))));
  localStorage.setItem("pick_spell", String(Math.max(0, Number(setSpell.value || 0))));
  modal.classList.remove("open");
  roll();
});

document.getElementById("resetSettings").addEventListener("click", () => {
  localStorage.setItem("pick_gem", String(DEFAULTS.gem));
  localStorage.setItem("pick_relic", String(DEFAULTS.relic));
  localStorage.setItem("pick_spell", String(DEFAULTS.spell));
  modal.classList.remove("open");
  roll();
});

/* ===== ì´ë²¤íŠ¸ ===== */
document.getElementById("roll").addEventListener("click", roll);

/* ì²« ë¡œë”©: ìë™ ë½‘ê¸° */
roll();
</script>
</body>
</html>
