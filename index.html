<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</title>

<style>
:root{
  --bg1:#f6f7ff; --bg2:#eef1ff;
  --card:#ffffff; --text:#141427; --muted:#6b6f93;
  --line:#d7dcff; --accent:#5b6cff;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}
main{max-width:980px;margin:0 auto;padding:28px}
h1{margin:0 0 14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select,button,input{
  padding:10px 14px;
  font-size:15px;
  border-radius:12px;
}
select,input{border:1px solid var(--line); background:#fff}
button{
  border:0;background:var(--accent);
  color:#fff;font-weight:800;cursor:pointer
}
button.secondary{
  background:#fff;color:#1a1a2b;border:1px solid var(--line);
  font-weight:700;
}
button:hover{opacity:.92}
.hint{color:var(--muted);font-size:13px;margin-top:10px;line-height:1.5}
.grid{display:grid;gap:14px;margin-top:18px}
@media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
.card{
  background:#fff;border:1px solid var(--line);
  border-radius:16px;padding:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.06)
}
.card h2{margin:0 0 10px;font-size:16px}
.item{
  padding:10px 12px;border:1px solid #eef0ff;
  border-radius:12px;margin:10px 0
}
.meta{margin-top:6px;color:var(--muted);font-size:12px}
.badge{
  display:inline-block;margin-left:6px;
  padding:2px 7px;border-radius:999px;
  background:#eef0ff;color:#3c47a8;
  font-size:12px;font-weight:700;
  border:1px solid #d9ddff
}
.error{
  background:#fff2f2;border:1px solid #ffd1d1;
  color:#8a1f1f;padding:12px 14px;
  border-radius:14px;margin-top:14px
}
.item b{letter-spacing:.2px}

.settingRow{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
}
.settingRow label{
  width:110px;
  color:#2a2a42;
  font-weight:700;
}
.settingRow input{
  width:140px;
}
hr{
  border:0;border-top:1px solid #eef0ff;margin:16px 0;
}
.smallLink{
  color:var(--muted); font-size:12px; margin-top:10px;
}
</style>
</head>

<body>
<main>
  <h1>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</h1>

  <div class="row">
    <label>ê²Œì„ ì¢…ë¥˜</label>
    <select id="mode">
      <option value="base">ê¸°ë³¸</option>
      <option value="war">ì˜ì›í•œì „ìŸ</option>
      <option value="both" selected>ê¸°ë³¸ + ì˜ì›í•œì „ìŸ</option>
      <option value="random">ëœë¤</option>
    </select>

    <button id="roll">ğŸ² ë½‘ê¸°</button>
    <button id="openSettings" class="secondary">âš™ ì„¤ì •</button>
  </div>

  <!-- ë©”ì¸ í™”ë©´ -->
  <section id="screen-main">
    <div class="hint">
      ê·œì¹™: ë„¤ë©”ì‹œìŠ¤ 1 / ìºë¦­í„° 2 / (ì„¤ì •) ë³´ì„ / (ì„¤ì •) ìœ ë¬¼ / (ì„¤ì •) ì£¼ë¬¸ Â·
      <b>ë¬»ë¹„</b>ëŠ” ì–´ë–¤ ëª¨ë“œì—ì„œë„ í•­ìƒ í¬í•¨ Â· ì¤‘ë³µ ì—†ì´ ë½‘ê¸° Â· ì—í…Œë¥´ëŠ” í‘œì‹œìš©
    </div>

    <div id="msg" class="hint"></div>
    <div id="result" class="grid"></div>
  </section>

  <!-- ì„¤ì • í™”ë©´ -->
  <section id="screen-settings" style="display:none">
    <div class="card">
      <h2>ì„¤ì •</h2>
      <div class="hint" style="margin-top:6px">
        ë³´ì„ / ìœ ë¬¼ / ì£¼ë¬¸ ê°œìˆ˜ë¥¼ ë°”ê¿€ ìˆ˜ ìˆì–´. ì €ì¥í•˜ë©´ ë°”ë¡œ ë°˜ì˜ë˜ê³ , ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€ë¼.
      </div>

      <hr>

      <div class="settingRow">
        <label for="set-gem">ë³´ì„ ê°œìˆ˜</label>
        <input id="set-gem" type="number" min="0" step="1" />
      </div>

      <div class="settingRow">
        <label for="set-relic">ìœ ë¬¼ ê°œìˆ˜</label>
        <input id="set-relic" type="number" min="0" step="1" />
      </div>

      <div class="settingRow">
        <label for="set-spell">ì£¼ë¬¸ ê°œìˆ˜</label>
        <input id="set-spell" type="number" min="0" step="1" />
      </div>

      <div class="smallLink">
        ê¸°ë³¸ê°’: ë³´ì„ 2 / ìœ ë¬¼ 3 / ì£¼ë¬¸ 4
      </div>

      <hr>

      <div class="row">
        <button id="saveSettings">ì €ì¥</button>
        <button id="resetSettings" class="secondary">ì´ˆê¸°í™”</button>
        <button id="closeSettings" class="secondary">ë‹«ê¸°</button>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== ê³ ì • ê·œì¹™ ===== */
const FIXED_PICK = { "ë„¤ë©”ì‹œìŠ¤":1, "ìºë¦­í„°":2 };

/* ===== ëª¨ë“œ í—ˆìš© ===== */
function allowedKinds(mode){
  if(mode==="base") return new Set(["ê¸°ë³¸","ë¬»ë¹„"]);
  if(mode==="war")  return new Set(["ì˜ì „","ë¬»ë¹„"]);
  return new Set(["ê¸°ë³¸","ì˜ì „","ë¬»ë¹„"]);
}

/* ===== ì„¤ì • ì €ì¥/ë¡œë“œ (localStorage) ===== */
const DEFAULTS = { gem:2, relic:3, spell:4 };

function getNum(key, fallback){
  const v = localStorage.getItem(key);
  const n = Number(v);
  return Number.isFinite(n) ? n : fallback;
}

function getPickConfig(){
  return {
    "ë„¤ë©”ì‹œìŠ¤": 1,
    "ìºë¦­í„°": 2,
    "ë³´ì„": getNum("pick_gem", DEFAULTS.gem),
    "ìœ ë¬¼": getNum("pick_relic", DEFAULTS.relic),
    "ì£¼ë¬¸": getNum("pick_spell", DEFAULTS.spell)
  };
}

/* ===== ì •ê·œí™” ===== */
const clean = (v)=> (v ?? "").replace(/\uFEFF/g,"").trim();

function normCategory(v){
  v = clean(v);
  if(v.includes("ë„¤ë©”")) return "ë„¤ë©”ì‹œìŠ¤";
  if(v.includes("ìºë¦­")) return "ìºë¦­í„°";
  if(v.includes("ë³´ì„")) return "ë³´ì„";
  if(v.includes("ìœ ë¬¼")) return "ìœ ë¬¼";
  if(v.includes("ì£¼ë¬¸")) return "ì£¼ë¬¸";
  return v;
}
function normKind(v){
  v = clean(v);
  if(v.includes("ê¸°ë³¸")) return "ê¸°ë³¸";
  if(v.includes("ì˜"))   return "ì˜ì „"; // ì˜ì›í•œì „ìŸ/ì˜ì „ ëª¨ë‘ ì²˜ë¦¬
  if(v.includes("ë¬»"))   return "ë¬»ë¹„";
  return v;
}

/* ===== CSV ===== */
function parseCSV(text){
  const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);

  // í—¤ë”ê°€ ìˆëŠ” ê²½ìš° ìë™ ì œê±°
  const startIdx = (lines[0] && lines[0].includes("ì¹´í…Œê³ ë¦¬")) ? 1 : 0;

  const rows = [];
  for(let i=startIdx;i<lines.length;i++){
    const p = lines[i].split(",");
    const category = normCategory(p[0]);
    const kind = normKind(p[1]);
    const name = clean(p[2]);
    const ether = clean(p[3]);

    if(!category || !kind || !name) continue;
    rows.push({ category, kind, name, ether });
  }
  return rows;
}

async function loadData(){
  const res = await fetch("data.csv", { cache:"no-store" });
  if(!res.ok) throw new Error(`data.csvë¥¼ ëª» ë¶ˆëŸ¬ì™”ì–´ (HTTP ${res.status})`);
  return parseCSV(await res.text());
}

/* ===== ëœë¤ ===== */
function shuffled(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function sampleUnique(pool, n){
  if(n <= 0) return [];
  if(n > pool.length) throw new Error(`í›„ë³´ê°€ ${pool.length}ê°œë¼ì„œ ${n}ê°œë¥¼ ì¤‘ë³µ ì—†ì´ ë½‘ì„ ìˆ˜ ì—†ì–´.`);
  return shuffled(pool).slice(0,n);
}

/* ===== ë Œë” ===== */
function render(result, pickConfig){
  const box = document.getElementById("result");
  box.innerHTML = "";

  const order = ["ë„¤ë©”ì‹œìŠ¤","ìºë¦­í„°","ë³´ì„","ìœ ë¬¼","ì£¼ë¬¸"];
  for(const cat of order){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h2>${cat} <span class="meta">(ì„ íƒ ${pickConfig[cat]}ê°œ)</span></h2>`;

    for(const item of result[cat]){
      // ì—í…Œë¥´ ìˆ«ì ì•ˆì „ ì¶”ì¶œ â†’ "6â™ª ì¹´ë“œì´ë¦„"
      const etherNum = Number(String(item.ether ?? "").replace(/[^\d]/g,""));
      const title = (Number.isFinite(etherNum) && etherNum>0)
        ? `${etherNum}â™ª ${item.name}`
        : item.name;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div><b>${title}</b>${item.kind==="ë¬»ë¹„" ? `<span class="badge">ë¬»ë¹„</span>` : ""}</div>
        <div class="meta">${item.kind}</div>
      `;
      card.appendChild(div);
    }

    box.appendChild(card);
  }
}

/* ===== í™”ë©´ ì „í™˜ ===== */
const screenMain = document.getElementById("screen-main");
const screenSettings = document.getElementById("screen-settings");

function openSettings(){
  screenMain.style.display = "none";
  screenSettings.style.display = "block";

  document.getElementById("set-gem").value = getNum("pick_gem", DEFAULTS.gem);
  document.getElementById("set-relic").value = getNum("pick_relic", DEFAULTS.relic);
  document.getElementById("set-spell").value = getNum("pick_spell", DEFAULTS.spell);
}

function closeSettings(){
  screenSettings.style.display = "none";
  screenMain.style.display = "block";
}

/* ===== ë©”ì¸ ë½‘ê¸° ===== */
async function roll(){
  const msg = document.getElementById("msg");
  msg.innerHTML = "";

  // ê¸°ë³¸ê°’: both (HTMLì—ì„œ selectedë¡œ ì´ë¯¸ ì„¤ì •ë¨)

  // Aëª¨ë“œ: ëœë¤ ì„ íƒì´ë©´ ë½‘ê¸° ëˆ„ë¥¼ ë•Œë§ˆë‹¤ ëª¨ë“œ ëœë¤ í™•ì •
  let mode = document.getElementById("mode").value;
  if(mode === "random"){
    const choices = ["base","war","both"];
    mode = choices[Math.floor(Math.random() * choices.length)];
  }

  const modeLabel =
    mode==="base" ? "ê¸°ë³¸" :
    mode==="war" ? "ì˜ì›í•œì „ìŸ" :
    "ê¸°ë³¸ + ì˜ì›í•œì „ìŸ";

  msg.innerHTML = `ì´ë²ˆ íŒ ëª¨ë“œ: <b>${modeLabel}</b>`;

  try{
    const rows = await loadData();
    const allowed = allowedKinds(mode);
    const pickConfig = getPickConfig();

    // ì¹´í…Œê³ ë¦¬ë³„ í’€ êµ¬ì„±
    const byCat = {};
    for(const r of rows){
      if(!(r.category in pickConfig)) continue;
      if(!allowed.has(r.kind)) continue;
      (byCat[r.category] ||= []).push(r);
    }

    // ê²°ê³¼ ë½‘ê¸°
    const result = {};
    for(const [cat, cnt] of Object.entries(pickConfig)){
      const pool = byCat[cat] || [];
      result[cat] = sampleUnique(pool, cnt);
    }

    render(result, pickConfig);
  }catch(e){
    msg.innerHTML = `<div class="error">${e.message}</div>`;
    document.getElementById("result").innerHTML = "";
  }
}

/* ===== ì´ë²¤íŠ¸ ===== */
document.getElementById("roll").addEventListener("click", roll);
document.getElementById("openSettings").addEventListener("click", openSettings);
document.getElementById("closeSettings").addEventListener("click", closeSettings);

document.getElementById("saveSettings").addEventListener("click", () => {
  const gem = Math.max(0, Number(document.getElementById("set-gem").value || 0));
  const relic = Math.max(0, Number(document.getElementById("set-relic").value || 0));
  const spell = Math.max(0, Number(document.getElementById("set-spell").value || 0));

  localStorage.setItem("pick_gem", String(gem));
  localStorage.setItem("pick_relic", String(relic));
  localStorage.setItem("pick_spell", String(spell));

  closeSettings();
  roll(); // ì €ì¥ í›„ ì¦‰ì‹œ ë°˜ì˜
});

document.getElementById("resetSettings").addEventListener("click", () => {
  localStorage.removeItem("pick_gem");
  localStorage.removeItem("pick_relic");
  localStorage.removeItem("pick_spell");

  // ì…ë ¥ê°’ë„ ê¸°ë³¸ìœ¼ë¡œ
  document.getElementById("set-gem").value = DEFAULTS.gem;
  document.getElementById("set-relic").value = DEFAULTS.relic;
  document.getElementById("set-spell").value = DEFAULTS.spell;
});

/* ì²« ë¡œë”©: ìë™ ë½‘ê¸° */
roll();
</script>
</body>
</html>
