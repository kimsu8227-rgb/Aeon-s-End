<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</title>

<style>
:root{
  --bg1:#f6f7ff; --bg2:#eef1ff;
  --card:#ffffff; --text:#141427; --muted:#6b6f93;
  --line:#d7dcff; --accent:#5b6cff;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}
main{max-width:980px;margin:0 auto;padding:28px}
h1{margin:0 0 14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select,button{
  padding:10px 14px;
  font-size:15px;
  border-radius:12px;
}
select{border:1px solid var(--line);background:#fff}
button{
  border:0;background:var(--accent);
  color:#fff;font-weight:800;cursor:pointer
}
button:hover{opacity:.92}
.hint{color:var(--muted);font-size:13px;margin-top:10px}
.grid{display:grid;gap:14px;margin-top:18px}
@media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
.card{
  background:#fff;border:1px solid var(--line);
  border-radius:16px;padding:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.06)
}
.card h2{margin:0 0 10px;font-size:16px}
.item{
  padding:8px 10px;border:1px solid #eef0ff;
  border-radius:12px;margin:8px 0
}
.meta{margin-top:6px;color:var(--muted);font-size:12px}
.badge{
  display:inline-block;margin-left:6px;
  padding:2px 7px;border-radius:999px;
  background:#eef0ff;color:#3c47a8;
  font-size:12px;font-weight:700;
  border:1px solid #d9ddff
}
.error{
  background:#fff2f2;border:1px solid #ffd1d1;
  color:#8a1f1f;padding:12px 14px;
  border-radius:14px;margin-top:14px
}
.item b{letter-spacing:.2px}
</style>
</head>

<body>
<main>
<h1>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</h1>

<div class="row">
  <label>ê²Œì„ ì¢…ë¥˜</label>
  <select id="mode">
    <option value="base">ê¸°ë³¸</option>
    <option value="war">ì˜ì›í•œì „ìŸ</option>
    <option value="both" selected>ê¸°ë³¸ + ì˜ì›í•œì „ìŸ</option>
    <option value="random">ëœë¤</option>
  </select>
  <button id="roll">ğŸ² ë½‘ê¸°</button>
</div>

<div id="msg" class="hint"></div>
<div id="result" class="grid"></div>
</main>

<script>
/* ===== ê·œì¹™ ===== */
const PICK = { ë„¤ë©”ì‹œìŠ¤:1, ìºë¦­í„°:2, ë³´ì„:2, ìœ ë¬¼:3, ì£¼ë¬¸:4 };

function allowedKinds(mode){
  if(mode==="base") return new Set(["ê¸°ë³¸","ë¬»ë¹„"]);
  if(mode==="war")  return new Set(["ì˜ì „","ë¬»ë¹„"]);
  return new Set(["ê¸°ë³¸","ì˜ì „","ë¬»ë¹„"]);
}

/* ===== ìœ í‹¸ ===== */
const clean = v => (v ?? "").replace(/\uFEFF/g,"").trim();

function normCategory(v){
  if(v.includes("ë„¤ë©”")) return "ë„¤ë©”ì‹œìŠ¤";
  if(v.includes("ìºë¦­")) return "ìºë¦­í„°";
  if(v.includes("ë³´ì„")) return "ë³´ì„";
  if(v.includes("ìœ ë¬¼")) return "ìœ ë¬¼";
  if(v.includes("ì£¼ë¬¸")) return "ì£¼ë¬¸";
  return v;
}
function normKind(v){
  if(v.includes("ê¸°ë³¸")) return "ê¸°ë³¸";
  if(v.includes("ì˜"))   return "ì˜ì „";
  if(v.includes("ë¬»"))   return "ë¬»ë¹„";
  return v;
}

function parseCSV(text){
  return text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(line=>{
    const p = line.split(",");
    return {
      category: normCategory(clean(p[0])),
      kind: normKind(clean(p[1])),
      name: clean(p[2]),
      ether: clean(p[3])
    };
  });
}

function shuffle(arr){
  return arr.slice().sort(()=>Math.random()-0.5);
}

async function loadData(){
  const res = await fetch("data.csv",{cache:"no-store"});
  if(!res.ok) throw new Error("data.csv ë¡œë“œ ì‹¤íŒ¨");
  return parseCSV(await res.text());
}

/* ===== ë Œë” ===== */
function render(result){
  const box = document.getElementById("result");
  box.innerHTML = "";

  for(const cat in PICK){
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<h2>${cat}</h2>`;

    for(const item of result[cat]){
      const etherNum = Number(item.ether.replace(/[^\d]/g,""));
      const title = etherNum ? `${etherNum}â™ª ${item.name}` : item.name;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div><b>${title}</b>${item.kind==="ë¬»ë¹„" ? `<span class="badge">ë¬»ë¹„</span>`:""}</div>
        <div class="meta">${item.kind}</div>
      `;
      card.appendChild(div);
    }
    box.appendChild(card);
  }
}

/* ===== ë©”ì¸ ===== */
async function roll(){
  const msg = document.getElementById("msg");
  msg.textContent = "";

  let mode = document.getElementById("mode").value;

  if(mode==="random"){
    const choices = ["base","war","both"];
    mode = choices[Math.floor(Math.random()*choices.length)];
  }

  const label = mode==="base"?"ê¸°ë³¸":mode==="war"?"ì˜ì›í•œì „ìŸ":"ê¸°ë³¸ + ì˜ì›í•œì „ìŸ";
  msg.innerHTML = `ì´ë²ˆ íŒ ëª¨ë“œ: <b>${label}</b>`;

  try{
    const rows = await loadData();
    const allowed = allowedKinds(mode);

    const byCat = {};
    for(const r of rows){
      if(!PICK[r.category]) continue;
      if(!allowed.has(r.kind)) continue;
      (byCat[r.category] ||= []).push(r);
    }

    const result = {};
    for(const cat in PICK){
      result[cat] = shuffle(byCat[cat]).slice(0,PICK[cat]);
    }

    render(result);
  }catch(e){
    msg.innerHTML = `<div class="error">${e.message}</div>`;
  }
}

document.getElementById("roll").addEventListener("click", roll);
roll();
</script>
</body>
</html>
