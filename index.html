<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</title>

<style>
:root{
  --bg1:#f6f7ff; --bg2:#eef1ff;
  --card:#ffffff; --text:#141427; --muted:#6b6f93;
  --line:#d7dcff; --accent:#5b6cff;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}
main{max-width:980px;margin:0 auto;padding:28px}
h1{margin:0 0 14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
select,button,input{
  padding:10px 14px;
  font-size:15px;
  border-radius:12px;
}
select,input{border:1px solid var(--line); background:#fff}
button{
  border:0;background:var(--accent);
  color:#fff;font-weight:800;cursor:pointer
}
button.secondary{
  background:#fff;color:#1a1a2b;border:1px solid var(--line);
  font-weight:700;
}
button:hover{opacity:.92}
.hint{color:var(--muted);font-size:13px;margin-top:10px;line-height:1.5}
.grid{display:grid;gap:14px;margin-top:18px}
@media(min-width:860px){.grid{grid-template-columns:1fr 1fr}}
.card{
  background:#fff;border:1px solid var(--line);
  border-radius:16px;padding:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.06)
}
.card h2{margin:0 0 10px;font-size:16px}
.item{
  padding:10px 12px;border:1px solid #eef0ff;
  border-radius:12px;margin:10px 0
}
.meta{margin-top:6px;color:var(--muted);font-size:12px}
.badge{
  display:inline-block;margin-left:6px;
  padding:2px 7px;border-radius:999px;
  background:#eef0ff;color:#3c47a8;
  font-size:12px;font-weight:700;
  border:1px solid #d9ddff
}
.error{
  background:#fff2f2;border:1px solid #ffd1d1;
  color:#8a1f1f;padding:12px 14px;
  border-radius:14px;margin-top:14px
}
.item b{letter-spacing:.2px}

/* ===== ëª¨ë‹¬ ===== */
.modal{
  position:fixed; inset:0;
  background:rgba(20,22,60,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal.open{display:flex}
.modalBox{
  width:min(420px,90vw);
  background:#fff;
  border-radius:18px;
  padding:20px;
  box-shadow:0 20px 50px rgba(0,0,0,.25);
}
.modalBox h2{margin:0 0 8px}
.modalRow{
  display:flex; align-items:center; justify-content:space-between;
  gap:12px; margin:12px 0;
}
.modalRow label{font-weight:700}
.modalActions{
  display:flex; gap:10px; justify-content:flex-end; margin-top:18px;
}
</style>
</head>

<body>
<main>
<h1>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</h1>

<div class="row">
  <label>ê²Œì„ ì¢…ë¥˜</label>
  <select id="mode">
    <option value="base">ê¸°ë³¸</option>
    <option value="war">ì˜ì›í•œì „ìŸ</option>
    <option value="both" selected>ê¸°ë³¸ + ì˜ì›í•œì „ìŸ</option>
    <option value="random">ëœë¤</option>
  </select>

  <button id="roll">ğŸ² ë½‘ê¸°</button>
  <button id="openSettings" class="secondary">âš™ ì„¤ì •</button>
</div>

<div class="hint">
  ê¸°ë³¸ê°’: ë³´ì„ 2 / ìœ ë¬¼ 3 / ì£¼ë¬¸ 4 Â·
  <b>ë¬»ë¹„</b>ëŠ” ì–´ë–¤ ëª¨ë“œì—ì„œë„ í•­ìƒ í¬í•¨ Â· ì¤‘ë³µ ì—†ì´ ë½‘ê¸°
</div>

<div id="msg" class="hint"></div>
<div id="result" class="grid"></div>
</main>

<!-- ===== ì„¤ì • ëª¨ë‹¬ ===== -->
<div id="settingsModal" class="modal">
  <div class="modalBox">
    <h2>ì¹´ë“œ ê°œìˆ˜ ì„¤ì •</h2>
    <div class="hint">ì €ì¥í•˜ë©´ ì¦‰ì‹œ ë°˜ì˜ë¼.</div>

    <div class="modalRow">
      <label>ë³´ì„</label>
      <input type="number" id="set-gem" min="0">
    </div>
    <div class="modalRow">
      <label>ìœ ë¬¼</label>
      <input type="number" id="set-relic" min="0">
    </div>
    <div class="modalRow">
      <label>ì£¼ë¬¸</label>
      <input type="number" id="set-spell" min="0">
    </div>

    <div class="modalActions">
      <button id="resetSettings" class="secondary">ì´ˆê¸°í™”</button>
      <button id="saveSettings">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
/* ===== ê¸°ë³¸ê°’ ===== */
const DEFAULTS = { gem:2, relic:3, spell:4 };

/* ===== ê·œì¹™ ===== */
function allowedKinds(mode){
  if(mode==="base") return new Set(["ê¸°ë³¸","ë¬»ë¹„"]);
  if(mode==="war")  return new Set(["ì˜ì „","ë¬»ë¹„"]);
  return new Set(["ê¸°ë³¸","ì˜ì „","ë¬»ë¹„"]);
}

function getNum(key, d){
  const v = Number(localStorage.getItem(key));
  return Number.isFinite(v) ? v : d;
}

function getPickConfig(){
  return {
    ë„¤ë©”ì‹œìŠ¤:1,
    ìºë¦­í„°:2,
    ë³´ì„:getNum("pick_gem",DEFAULTS.gem),
    ìœ ë¬¼:getNum("pick_relic",DEFAULTS.relic),
    ì£¼ë¬¸:getNum("pick_spell",DEFAULTS.spell)
  };
}

/* ===== CSV ===== */
const clean = v => (v??"").replace(/\uFEFF/g,"").trim();
const normCategory = v =>
  v.includes("ë„¤ë©”")?"ë„¤ë©”ì‹œìŠ¤":
  v.includes("ìºë¦­")?"ìºë¦­í„°":
  v.includes("ë³´ì„")?"ë³´ì„":
  v.includes("ìœ ë¬¼")?"ìœ ë¬¼":
  v.includes("ì£¼ë¬¸")?"ì£¼ë¬¸":v;
const normKind = v =>
  v.includes("ê¸°ë³¸")?"ê¸°ë³¸":
  v.includes("ì˜")?"ì˜ì „":
  v.includes("ë¬»")?"ë¬»ë¹„":v;

async function loadData(){
  const r = await fetch("data.csv",{cache:"no-store"});
  const t = await r.text();
  return t.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(l=>{
    const p=l.split(",");
    return {
      category:normCategory(clean(p[0])),
      kind:normKind(clean(p[1])),
      name:clean(p[2]),
      ether:clean(p[3])
    };
  });
}

const shuffle=a=>a.slice().sort(()=>Math.random()-0.5);

/* ===== ë Œë” ===== */
function render(result){
  const box=document.getElementById("result");
  box.innerHTML="";
  for(const cat in result){
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<h2>${cat}</h2>`;
    for(const it of result[cat]){
      const n=Number(it.ether.replace(/[^\d]/g,""));
      const title=n?`${n}â™ª ${it.name}`:it.name;
      const d=document.createElement("div");
      d.className="item";
      d.innerHTML=`<b>${title}</b><div class="meta">${it.kind}</div>`;
      card.appendChild(d);
    }
    box.appendChild(card);
  }
}

/* ===== ë©”ì¸ ===== */
async function roll(){
  let mode=document.getElementById("mode").value;
  if(mode==="random"){
    mode=["base","war","both"][Math.floor(Math.random()*3)];
  }
  document.getElementById("msg").innerHTML=
    `ì´ë²ˆ íŒ ëª¨ë“œ: <b>${mode==="base"?"ê¸°ë³¸":mode==="war"?"ì˜ì›í•œì „ìŸ":"ê¸°ë³¸ + ì˜ì›í•œì „ìŸ"}</b>`;

  const rows=await loadData();
  const allowed=allowedKinds(mode);
  const pick=getPickConfig();
  const byCat={};

  for(const r of rows){
    if(!(r.category in pick)) continue;
    if(!allowed.has(r.kind)) continue;
    (byCat[r.category] ||= []).push(r);
  }

  const result={};
  for(const c in pick){
    result[c]=shuffle(byCat[c]||[]).slice(0,pick[c]);
  }
  render(result);
}

/* ===== ëª¨ë‹¬ ===== */
const modal=document.getElementById("settingsModal");
document.getElementById("openSettings").onclick=()=>{
  modal.classList.add("open");
  setGem.value=getNum("pick_gem",2);
  setRelic.value=getNum("pick_relic",3);
  setSpell.value=getNum("pick_spell",4);
};
modal.onclick=e=>{ if(e.target===modal) modal.classList.remove("open"); };

saveSettings.onclick=()=>{
  localStorage.setItem("pick_gem",setGem.value);
  localStorage.setItem("pick_relic",setRelic.value);
  localStorage.setItem("pick_spell",setSpell.value);
  modal.classList.remove("open");
  roll();
};
resetSettings.onclick=()=>{
  localStorage.clear();
  modal.classList.remove("open");
  roll();
};

rollBtn=document.getElementById("roll");
rollBtn.onclick=roll;
roll();
</script>
</body>
</html>
