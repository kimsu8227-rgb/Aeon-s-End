<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</title>
  <style>
    :root{--bg:#0b1020;--card:#111a33;--muted:#9aa7c2;--text:#eaf0ff;--accent:#7c5cff;--line:rgba(255,255,255,.10);}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      background:radial-gradient(1200px 900px at 20% 0%, #18214a 0%, var(--bg) 55%);color:var(--text)}
    header{max-width:980px;margin:0 auto;padding:26px 18px 10px}
    h1{margin:0;font-size:22px;letter-spacing:-.3px}
    p{margin:8px 0 0;color:var(--muted);line-height:1.55}
    main{max-width:980px;margin:0 auto;padding:18px;display:grid;gap:14px}
    .grid{display:grid;gap:12px}
    @media (min-width:860px){ .grid{grid-template-columns:1.1fr .9fr} }
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);border-radius:16px;padding:14px}
    .card h2{margin:0 0 10px;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    button{border:0;border-radius:12px;padding:11px 14px;font-weight:800;cursor:pointer}
    .primary{background:var(--accent);color:white}
    .ghost{background:transparent;color:var(--text);border:1px solid var(--line)}
    textarea, select{
      background:rgba(0,0,0,.22);color:var(--text);
      border:1px solid var(--line);border-radius:12px;padding:10px 12px;outline:none;
    }
    textarea{width:100%;min-height:260px;resize:vertical}
    .small{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .result{display:grid;gap:10px}
    .result-item{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(0,0,0,.18)}
    .result-item .k{color:var(--muted);font-size:12px;margin-bottom:6px}
    .result-item .v{font-size:16px;font-weight:900;letter-spacing:-.2px}
    .meta{margin-top:4px;color:var(--muted);font-size:12px}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <h1>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</h1>
    <p>ëª¨ë“œ(ê¸°ë³¸/ì˜ì „/ê¸°ë³¸+ì˜ì „) ì„ íƒ + <b>ë¬»ë¹„ í•­ëª©ì€ í•­ìƒ í¬í•¨</b> + ì¤‘ë³µ ì—†ì´ ë½‘ê¸°</p>
  </header>

  <main class="grid">
    <section class="card">
      <h2>ì„¤ì •</h2>
      <div class="row">
        <label class="small">ê²Œì„ ì¢…ë¥˜</label>
        <select id="mode">
          <option value="base">ê¸°ë³¸</option>
          <option value="war">ì˜ì›í•œì „ìŸ</option>
          <option value="both" selected>ê¸°ë³¸+ì˜ì›í•œì „ìŸ</option>
        </select>

        <button class="primary" id="btnRoll">ğŸ² ë½‘ê¸°</button>
        <button class="ghost" id="btnSave">ë°ì´í„° ì €ì¥</button>
        <button class="ghost" id="btnLoad">ì €ì¥ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>

      <div class="hr"></div>

      <h2>ë°ì´í„° ì…ë ¥</h2>
      <p class="small">
        í˜•ì‹: ê° ì¤„ì´ 1ê°œ í•­ëª©ì´ë©° <code>ì¹´í…Œê³ ë¦¬,ì¢…ë¥˜,ì´ë¦„,ì—í…Œë¥´(ì—†ìœ¼ë©´ ë¹ˆì¹¸)</code><br/>
        ì¢…ë¥˜ëŠ” <b>ê¸°ë³¸</b>, <b>ì˜ì „</b>, <b>ë¬»ë¹„</b> ì¤‘ í•˜ë‚˜ë¡œ ì¨ì¤˜. (ë¬»ë¹„ëŠ” ì–´ë–¤ ëª¨ë“œì—ì„œë„ í¬í•¨ë¨)
      </p>

      <textarea id="data"></textarea>
      <p class="small">ì˜ˆì‹œ) <code>ë³´ì„,ê¸°ë³¸,ì˜¥,2</code> / <code>ë„¤ë©”ì‹œìŠ¤,ë¬»ë¹„,ì§‘ìš”í•œì „íˆ¬êµ°í•¨,7</code></p>
    </section>

    <section class="card">
      <h2>ê²°ê³¼</h2>
      <div class="result" id="result"></div>
      <p class="small" id="hint"></p>
    </section>
  </main>

<script>
/** ====== ê³ ì • ê·œì¹™ ====== */
const PICK_COUNTS = {
  "ë„¤ë©”ì‹œìŠ¤": 1,
  "ìºë¦­í„°": 2,
  "ë³´ì„": 2,
  "ìœ ë¬¼": 3,
  "ì£¼ë¬¸": 4
};

// ê¸°ë³¸ ë°ì´í„°(ë¹„ì›Œë‘ ). ë„ˆëŠ” ì—¬ê¸° ë§ê³ , ìœ„ í…ìŠ¤íŠ¸ë°•ìŠ¤ì— ë¶™ì—¬ë„£ì–´ë„ ë¨.
const DEFAULT_DATA = `# ì—¬ê¸°ì— í‘œ ë‚´ìš©ì„ ì•„ë˜ í˜•ì‹ìœ¼ë¡œ ë¶™ì—¬ë„£ê¸°
# ì¹´í…Œê³ ë¦¬,ì¢…ë¥˜,ì´ë¦„,ì—í…Œë¥´
# ì¢…ë¥˜: ê¸°ë³¸ / ì˜ì „ / ë¬»ë¹„
#
# ì˜ˆì‹œ:
ë„¤ë©”ì‹œìŠ¤,ê¸°ë³¸,ë’¤í‹€ë¦°ê°€ë©´,
ìºë¦­í„°,ì˜ì „,ê°€ë¥´ì¹¸,
ë³´ì„,ê¸°ë³¸,ì˜¥,2
ìœ ë¬¼,ë¬»ë¹„,ë¶ˆê½ƒë°©í˜¸ë¶€ì ,3
ì£¼ë¬¸,ì˜ì „,ì§‘ì–´ì‚¼í‚¤ëŠ”ê·¸ë¦¼ì,6
`;

const STORAGE_KEY = "aeonsend_randomizer_data_v1";

/** ====== ìœ í‹¸ ====== */
function mulberry32(seed) {
  let t = seed >>> 0;
  return function() {
    t += 0x6D2B79F5;
    let x = Math.imul(t ^ (t >>> 15), 1 | t);
    x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
    return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
  };
}

function hashStringToSeed(str) {
  // ê°„ë‹¨ í•´ì‹œ(ê²°ê³¼ ì¬í˜„ìš©). ì‹œë“œë¥¼ ë”°ë¡œ ì“°ê³  ì‹¶ìœ¼ë©´ í™•ì¥ ê°€ëŠ¥.
  let h = 2166136261;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}

function sampleWithoutReplacement(arr, n, rand) {
  if (n > arr.length) throw new Error(`í‘œë³¸ ${n}ê°œë¥¼ ë½‘ê¸°ì—” í›„ë³´ê°€ ${arr.length}ê°œë¿ì´ì•¼.`);
  const a = arr.slice();
  // Fisherâ€“Yates shuffle ë¶€ë¶„ë§Œ nê°œ ë½‘ê¸°
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rand() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a.slice(0, n);
}

/** ====== íŒŒì„œ ====== */
function parseData(text) {
  const rows = [];
  const lines = text.split(/\r?\n/);
  for (const raw of lines) {
    const line = raw.trim();
    if (!line || line.startsWith("#")) continue;
    const parts = line.split(",").map(s => s.trim());
    if (parts.length < 3) continue;
    const [category, kind, name] = parts;
    const ether = (parts[3] ?? "").trim();
    rows.push({
      category,
      kind, // ê¸°ë³¸ / ì˜ì „ / ë¬»ë¹„
      name,
      ether: ether === "" ? null : Number(ether)
    });
  }
  return rows;
}

function allowedKindsByMode(mode) {
  // ë¬»ë¹„ëŠ” í•­ìƒ í¬í•¨!
  if (mode === "base") return new Set(["ê¸°ë³¸", "ë¬»ë¹„"]);
  if (mode === "war")  return new Set(["ì˜ì „", "ë¬»ë¹„"]);
  return new Set(["ê¸°ë³¸", "ì˜ì „", "ë¬»ë¹„"]); // both
}

/** ====== ë©”ì¸ ë¡œì§ ====== */
function roll(mode, dataText) {
  const seed = hashStringToSeed(mode + "|" + dataText); // ê°™ì€ ë°ì´í„°+ëª¨ë“œë©´ ê²°ê³¼ ì¬í˜„
  const rand = mulberry32(seed);

  const rows = parseData(dataText);
  const allowed = allowedKindsByMode(mode);

  // ì¹´í…Œê³ ë¦¬ë³„ í›„ë³´ í’€
  const poolByCat = {};
  for (const r of rows) {
    if (!PICK_COUNTS[r.category]) continue; // ì •ì˜ ì•ˆ ëœ ì¹´í…Œê³ ë¦¬ ë¬´ì‹œ
    if (!allowed.has(r.kind)) continue;
    poolByCat[r.category] ??= [];
    poolByCat[r.category].push(r);
  }

  // ê° ì¹´í…Œê³ ë¦¬ ì¤‘ë³µ ì—†ì´ ë½‘ê¸°
  const result = {};
  for (const [cat, cnt] of Object.entries(PICK_COUNTS)) {
    const pool = poolByCat[cat] ?? [];
    const picks = sampleWithoutReplacement(pool, cnt, rand);
    result[cat] = picks;
  }

  return { seed, result };
}

function render({ seed, result }, mode) {
  const box = document.getElementById("result");
  box.innerHTML = "";

  const modeLabel = mode === "base" ? "ê¸°ë³¸" : mode === "war" ? "ì˜ì›í•œì „ìŸ" : "ê¸°ë³¸+ì˜ì›í•œì „ìŸ";
  const hint = document.getElementById("hint");
  hint.textContent = `ëª¨ë“œ: ${modeLabel} Â· (ì¬í˜„ìš© ì‹œë“œ: ${seed}) Â· ë¬»ë¹„ í•­ëª©ì€ í•­ìƒ í’€ì— í¬í•¨`;

  for (const cat of Object.keys(PICK_COUNTS)) {
    const picks = result[cat] ?? [];
    const wrap = document.createElement("div");
    wrap.className = "result-item";

    const k = document.createElement("div");
    k.className = "k";
    k.textContent = `${cat} (${picks.length}ê°œ)`;
    wrap.appendChild(k);

    for (const p of picks) {
      const v = document.createElement("div");
      v.className = "v";
      const etherText = (p.ether === null || Number.isNaN(p.ether)) ? "" : ` Â· ì—í…Œë¥´ ${p.ether}`;
      v.textContent = `${p.name}${etherText}`;
      wrap.appendChild(v);

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `ì¢…ë¥˜: ${p.kind}`;
      wrap.appendChild(meta);
    }

    box.appendChild(wrap);
  }
}

/** ====== UI ====== */
const dataEl = document.getElementById("data");
dataEl.value = DEFAULT_DATA;

document.getElementById("btnRoll").addEventListener("click", () => {
  try {
    const mode = document.getElementById("mode").value;
    const out = roll(mode, dataEl.value);
    render(out, mode);
  } catch (e) {
    alert(e.message || String(e));
  }
});

document.getElementById("btnSave").addEventListener("click", () => {
  localStorage.setItem(STORAGE_KEY, dataEl.value);
  alert("ë°ì´í„° ì €ì¥ ì™„ë£Œ!");
});

document.getElementById("btnLoad").addEventListener("click", () => {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return alert("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ì–´!");
  dataEl.value = saved;
  alert("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
});

// ì²« í™”ë©´ ì•ˆë‚´
document.getElementById("hint").textContent =
  "ì™¼ìª½ í…ìŠ¤íŠ¸ë°•ìŠ¤ì— í‘œ ë°ì´í„°ë¥¼ í˜•ì‹ëŒ€ë¡œ ì±„ìš´ ë’¤ â€˜ë½‘ê¸°â€™ë¥¼ ëˆŒëŸ¬ë´!";
</script>
</body>
</html>
