<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ì—ì´ì–¸ì¦ˆ ì—”ë“œ ëœë”ë§ˆì´ì €</title>

<style>
*{ box-sizing:border-box; }

:root{
  --box:#ffffff;
  --border:#cfd7ff;
  --text:#101325;
  --muted:#4b5283;
  --accent:#5c66ff;
}

body{
  margin:0;
  font-family:system-ui,-apple-system,"Noto Sans KR",sans-serif;
  background:
    repeating-linear-gradient(
      90deg,
      rgba(40,55,120,.08) 0px,
      rgba(40,55,120,.08) 2px,
      rgba(255,255,255,1) 2px,
      rgba(255,255,255,1) 14px
    );
  color:var(--text);
}

main{
  max-width:920px;
  margin:0 auto;
  padding:28px;
}

h1{
  margin:6px 0 18px;
  font-size:36px;
  letter-spacing:3px;
  text-align:center;
  color:#15183a;
}

.row{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
  justify-content:center;
}

select,button,input{
  padding:10px 14px;
  font-size:15px;
  border-radius:12px;
}

select,input{
  border:1px solid var(--border);
  background:#ffffff;
  color:var(--text);
}

button{
  border:0;
  background:linear-gradient(180deg,#7f8bff,#5c66ff);
  color:white;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 8px 18px rgba(92,102,255,.20);
}
button.secondary{
  background:#ffffff;
  border:1px solid var(--border);
  color:var(--text);
  box-shadow:none;
}
button:hover{opacity:.92}

#msg{
  text-align:center;
  margin-top:14px;
  font-size:15px;
  color:#2b2f5a;
}

/* ê²°ê³¼ í‘œ */
.table{
  margin-top:22px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

/* í–‰ ì „ì²´ ë°•ìŠ¤ */
.rowItem{
  display:grid;
  grid-template-columns:130px 1fr;
  gap:16px;
  padding:16px;
  border-radius:18px;
  border:1px solid rgba(0,0,0,.08);
  box-shadow:0 8px 20px rgba(0,0,0,.06);
  align-items:center; /* ì„¸ë¡œ ê°€ìš´ë° ì •ë ¬ */
}

/* ì¹´í…Œê³ ë¦¬ë³„ í–‰ ë°°ê²½ */
.rowItem[data-cat="ë„¤ë©”ì‹œìŠ¤"]{ background:#fff1f1; border-color:#ffd0d0; }
.rowItem[data-cat="ìºë¦­í„°"]{ background:#f0fff6; border-color:#c9f3d8; }
.rowItem[data-cat="ë³´ì„"]{ background:#f4efff; border-color:#dacbff; }
.rowItem[data-cat="ìœ ë¬¼"]{ background:#eef6ff; border-color:#c6dcff; }
.rowItem[data-cat="ì£¼ë¬¸"]{ background:#fff9e6; border-color:#f0dc8a; }

/* ì™¼ìª½ ì œëª© ë°•ìŠ¤ */
.rowTitle{
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-weight:900;
  letter-spacing:1px;
  font-size:18px;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px 8px;
  background:linear-gradient(180deg,#fbfbff,#f2f4ff);
}

/* ì˜¤ë¥¸ìª½ ë‚´ìš© */
.rowContent{
  display:flex;
  flex-wrap:wrap;
  gap:10px 12px;
  align-items:center; /* ì„¸ë¡œ ê°€ìš´ë° ì •ë ¬ */
}

/* pill */
.pill{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#ffffff;
  color:var(--text);
  font-size:16px;
  white-space:nowrap;
  font-weight:650;
  letter-spacing:-0.1px;
  box-shadow:0 2px 6px rgba(25,35,80,.10);
}

.pill .ether{
  font-weight:900;
  color:#1f2aa8;
  background:#eef1ff;
  border:1px solid #d7dcff;
  padding:2px 8px;
  border-radius:999px;
}

/* í•˜ë‹¨ ì˜ì—­ */
.footer-area{
  margin-top:28px;
  padding-top:14px;
  border-top:1px dashed #d7dcff;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}

.hint.bottom{
  margin-top:0;
  padding-top:0;
  text-align:center;
  font-size:13px;
  color:#6b70a5;
}

/* ëª¨ë‹¬ */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal.open{display:flex}

.modalBox{
  width:360px;
  background:#ffffff;
  border:1px solid var(--border);
  border-radius:18px;
  padding:20px;
  box-shadow:0 30px 70px rgba(25,35,80,.25);
  color:var(--text);
}
.modalBox h2{
  margin:0 0 10px;
  text-align:center;
}
.modalRow{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin:16px 0;
}
.modalActions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:18px;
}
</style>
</head>

<body>
<main>
  <h1>AEONâ€™S END</h1>

  <div class="row">
    <label>ê²Œì„ ì¢…ë¥˜</label>
    <select id="mode">
      <option value="base">ê¸°ë³¸</option>
      <option value="war">ì˜ì›í•œì „ìŸ</option>
      <option value="both" selected>ê¸°ë³¸ + ì˜ì›í•œì „ìŸ</option>
      <option value="random">ëœë¤</option>
    </select>
    <button id="roll">ğŸ² ë½‘ê¸°</button>
  </div>

  <div id="msg"></div>
  <div id="result" class="table"></div>

  <div class="footer-area">
    <button id="openSettings" class="secondary">âš™ ì„¤ì •</button>
    <div class="hint bottom">ì¤‘ë³µ ì—†ì´ ë½‘ê¸° Â· ì—í…Œë¥´ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬</div>
  </div>
</main>

<!-- ì„¤ì • ëª¨ë‹¬ -->
<div id="settingsModal" class="modal">
  <div class="modalBox">
    <h2>ì¹´ë“œ ê°œìˆ˜ ì„¤ì •</h2>
    <div class="modalRow"><span>ë³´ì„</span><input id="set-gem" type="number" min="0"></div>
    <div class="modalRow"><span>ìœ ë¬¼</span><input id="set-relic" type="number" min="0"></div>
    <div class="modalRow"><span>ì£¼ë¬¸</span><input id="set-spell" type="number" min="0"></div>
    <div class="modalActions">
      <button id="resetSettings" class="secondary">ì´ˆê¸°í™”</button>
      <button id="saveSettings">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
/* ===== ê¸°ë³¸ ì„¸íŒ… (ì €ì¥) ===== */
const DEFAULTS={gem:2,relic:3,spell:4};
function ensureDefaults(){
  if(localStorage.getItem("pick_gem")==null) localStorage.setItem("pick_gem",String(DEFAULTS.gem));
  if(localStorage.getItem("pick_relic")==null) localStorage.setItem("pick_relic",String(DEFAULTS.relic));
  if(localStorage.getItem("pick_spell")==null) localStorage.setItem("pick_spell",String(DEFAULTS.spell));
}
ensureDefaults();
const getNum=(k,d)=>Number(localStorage.getItem(k))||d;

/* ===== ëª¨ë“œ ===== */
function allowedKinds(mode){
  if(mode==="base") return new Set(["ê¸°ë³¸","ë¬»ë¹„"]);
  if(mode==="war")  return new Set(["ì˜ì „","ë¬»ë¹„"]);
  return new Set(["ê¸°ë³¸","ì˜ì „","ë¬»ë¹„"]);
}

/* ===== CSV ===== */
const clean=v=>(v??"").replace(/\uFEFF/g,"").trim();
const normCat=v=>v.includes("ë„¤ë©”")?"ë„¤ë©”ì‹œìŠ¤":v.includes("ìºë¦­")?"ìºë¦­í„°":v.includes("ë³´ì„")?"ë³´ì„":v.includes("ìœ ë¬¼")?"ìœ ë¬¼":v.includes("ì£¼ë¬¸")?"ì£¼ë¬¸":v;
const normKind=v=>v.includes("ê¸°ë³¸")?"ê¸°ë³¸":v.includes("ì˜")?"ì˜ì „":v.includes("ë¬»")?"ë¬»ë¹„":v;

async function loadData(){
  const r=await fetch("data.csv",{cache:"no-store"});
  if(!r.ok) throw new Error(`data.csvë¥¼ ëª» ë¶ˆëŸ¬ì™”ì–´ (HTTP ${r.status})`);
  const t=await r.text();
  return t.split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(l=>{
    const p=l.split(",");
    return {category:normCat(clean(p[0])), kind:normKind(clean(p[1])), name:clean(p[2]), ether:clean(p[3])};
  });
}

/* ===== ìœ í‹¸ ===== */
const etherVal=i=>Number(String(i.ether??"").replace(/[^\d]/g,""))||Infinity;
const shuffle=a=>a.slice().sort(()=>Math.random()-0.5);

/* ===== ë Œë” ===== */
function render(result){
  const box = document.getElementById("result");
  box.innerHTML = "";
  const order = ["ë„¤ë©”ì‹œìŠ¤","ìºë¦­í„°","ë³´ì„","ìœ ë¬¼","ì£¼ë¬¸"];

  for(const cat of order){
    const row = document.createElement("div");
    row.className = "rowItem";
    row.dataset.cat = cat;

    const t = document.createElement("div");
    t.className = "rowTitle";
    t.textContent = cat;

    const c = document.createElement("div");
    c.className = "rowContent";

    for(const it of (result[cat] || [])){
      const pill = document.createElement("span");
      pill.className = "pill"; // âœ… ë¬»ë¹„ í‘œì‹œ ì œê±°

      const etherNum = Number(String(it.ether ?? "").replace(/[^\d]/g,"")) || 0;
      pill.innerHTML = etherNum
        ? `<span class="ether">${etherNum}â™ª</span><span>${it.name}</span>`
        : `<span>${it.name}</span>`;

      c.appendChild(pill);
    }

    row.append(t, c);
    box.appendChild(row);
  }
}

/* ===== ë©”ì¸ ===== */
async function doRoll(){
  try{
    let mode = document.getElementById("mode").value;
    if(mode === "random") mode = ["base","war","both"][Math.floor(Math.random()*3)];

    document.getElementById("msg").innerHTML =
      `ì´ë²ˆ íŒ ëª¨ë“œ: <b>${mode==="base"?"ê¸°ë³¸":mode==="war"?"ì˜ì›í•œì „ìŸ":"ê¸°ë³¸ + ì˜ì›í•œì „ìŸ"}</b>`;

    const rows = await loadData();
    const allowed = allowedKinds(mode);

    const pick = {
      ë„¤ë©”ì‹œìŠ¤: 1,
      ìºë¦­í„°: 2,
      ë³´ì„: getNum("pick_gem", 2),
      ìœ ë¬¼: getNum("pick_relic", 3),
      ì£¼ë¬¸: getNum("pick_spell", 4)
    };

    const byCat = {};
    for(const r of rows){
      if(!(r.category in pick)) continue;
      if(!allowed.has(r.kind)) continue;
      (byCat[r.category] ||= []).push(r);
    }

    const result = {};
    for(const c in pick){
      const pool = byCat[c] || [];
      if(pool.length < pick[c]) throw new Error(`${c} í›„ë³´ê°€ ${pool.length}ê°œë¼ì„œ ${pick[c]}ê°œë¥¼ ì¤‘ë³µ ì—†ì´ ë½‘ì„ ìˆ˜ ì—†ì–´.`);
      result[c] = shuffle(pool).slice(0, pick[c]).sort((a,b)=>etherVal(a)-etherVal(b));
    }

    render(result);
  }catch(e){
    document.getElementById("msg").innerHTML = `<b style="color:#b00020;">${e.message}</b>`;
    document.getElementById("result").innerHTML = "";
  }
}

/* ===== ì„¤ì • ëª¨ë‹¬ ===== */
const modal = document.getElementById("settingsModal");
const setGem = document.getElementById("set-gem");
const setRelic = document.getElementById("set-relic");
const setSpell = document.getElementById("set-spell");

document.getElementById("openSettings").addEventListener("click", () => {
  modal.classList.add("open");
  setGem.value = getNum("pick_gem", 2);
  setRelic.value = getNum("pick_relic", 3);
  setSpell.value = getNum("pick_spell", 4);
});

modal.addEventListener("click", (e) => {
  if(e.target === modal) modal.classList.remove("open");
});

document.getElementById("saveSettings").addEventListener("click", () => {
  localStorage.setItem("pick_gem", String(Math.max(0, Number(setGem.value || 0))));
  localStorage.setItem("pick_relic", String(Math.max(0, Number(setRelic.value || 0))));
  localStorage.setItem("pick_spell", String(Math.max(0, Number(setSpell.value || 0))));
  modal.classList.remove("open");
  doRoll();
});

document.getElementById("resetSettings").addEventListener("click", () => {
  localStorage.setItem("pick_gem", "2");
  localStorage.setItem("pick_relic", "3");
  localStorage.setItem("pick_spell", "4");
  modal.classList.remove("open");
  doRoll();
});

document.getElementById("roll").addEventListener("click", doRoll);
doRoll();
</script>
</body>
</html>
